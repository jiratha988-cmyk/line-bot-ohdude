from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import (
    MessageEvent, TextMessage, TextSendMessage,
    JoinEvent, MemberLeftEvent, GroupNameChangeEvent
)
import os
import re

app = Flask(__name__)

# ‡πÉ‡∏ä‡πâ ENV variables
line_bot_api = LineBotApi(os.getenv("LINE_CHANNEL_ACCESS_TOKEN"))
handler = WebhookHandler(os.getenv("LINE_CHANNEL_SECRET"))

# ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ
DEFAULT_GROUP_NAME = "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤Oh!dudeVip"
# ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï ‡πÄ‡∏ä‡πà‡∏ô lin.ee/vZzQErv
ALLOWED_LINKS = ["lin.ee/vZzQErv", "line.me/R/ti/p/@ohshop"]

@app.route("/", methods=["GET"])
def home():
    return "LINE Bot is running!"

@app.route("/callback", methods=["POST"])
def callback():
    signature = request.headers.get("X-Line-Signature", "")
    body = request.get_data(as_text=True)

    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)

    return "OK"

# ‚úÖ ‡∏Å‡∏£‡∏ì‡∏µ‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°
@handler.add(MemberLeftEvent)
def handle_member_left(event):
    line_bot_api.push_message(
        event.source.group_id,
        TextSendMessage(text="üö® ‡∏°‡∏µ‡∏Ñ‡∏ô‡πÇ‡∏î‡∏ô‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏∞ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!")
    )

# ‚úÖ ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°
@handler.add(GroupNameChangeEvent)
def handle_group_rename(event):
    if event.group_name != DEFAULT_GROUP_NAME:
        line_bot_api.set_group_name(event.source.group_id, DEFAULT_GROUP_NAME)
        line_bot_api.push_message(
            event.source.group_id,
            TextSendMessage(text=f"üö´ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ! ‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô '{DEFAULT_GROUP_NAME}' ‡πÅ‡∏•‡πâ‡∏ß")
        )

# ‚úÖ ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå
@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    text = event.message.text

    # ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå
    urls = re.findall(r'https?://[^\s]+', text)
    for url in urls:
        if not any(allowed in url for allowed in ALLOWED_LINKS):
            # ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°
            line_bot_api.push_message(
                event.source.group_id,
                TextSendMessage(text=f"‚ö†Ô∏è ‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏õ‡∏•‡∏Å ‡πÜ ‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°: {url}")
            )
            return

    # ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏≠‡∏Å‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå
    return
